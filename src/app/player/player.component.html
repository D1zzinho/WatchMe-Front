<mat-progress-bar mode="indeterminate" color="warn" *ngIf="!timeoutEnded && (videoLoaded | async)"></mat-progress-bar>
<div class="content" *ngIf="videoLoaded | async">
  <div class="container">
<!--      <div class="row justify-content-md-center">-->
        <div [ngClass]="(similarVideos.length === 0 ? 'noSimilarVideos' : '') + ' nVideo-section justify-content-md-center'">

<!--            <div [ngClass]="pageType === 'classic' ? 'col-12 col-lg-9 col-xl-7' : 'col-12 col-lg-10 col-xl-9'">-->
                <!-- LEFT SIDE [VIDEO/COMMENTS] -->

          <div class="video-section">
            <div #player class="player" tabindex="0">

<!--              <canvas id="thumbnail" style="opacity: 0.4;"></canvas>-->

              <button *ngIf="videoIsMuted" (click)="videoIsMuted = false;" mdbBtn color="danger" class="position-absolute w-100 h-100 rounded-0 m-0 opacity-50" mdbWavesEffect><strong style="font-size: 20px;" class="text-white">Click to unmute</strong></button>
              <video #playerVideo preload="auto" [muted]="videoIsMuted" id="video" poster="{{ baseUrl }}/{{ cover }}" (ended)="videoEnded()">
                <source #playerSource id="source" src="{{ baseUrl }}/{{ path }}" type="video/mp4" />
              </video>

              <div #playerControls class="player-controls">
                <div #progress class="progress">
                  <div #filledProgress class="filled-progress"></div>
                  <div #filledBufferProgress class="filled-buffer-progress"></div>
                </div>

                <div #playPauseBtn class="ply-btn">
                  <button #togglePlay class="player-btn toggle-play" title="Toggle Play">
                    <i class="fa fa-play"></i>
                  </button>
                </div>

                <div #sliders class="sliders">
                  <div #volumeIcon id="vol"><i class="fa fa-volume-down"></i></div>
                  <input #volumeSlider type="range" id="volume" name="volume" title="Change volume"
                         class="player-slider" min="0" max="1" step="0.05" value="{{ volume }}" />

                  <div #speedIcon class="speed"><i class="fa fa-fast-forward"></i></div>
                  <input #speedSlider type="range" id="playbackRate" name="playbackRate" title="Change speed"
                         class="player-slider" min="0.5" max="8" step="0.5" value="{{ playbackRate }}"/>
                  <div #speedValue id="playbackRate_value">x{{ playbackRate }}</div>
                </div>

                <div #timeHolder class="time">00:00 / 00:00</div>

                <button #fullScreenBtn id="full-screen" class="player-btn" title="Toggle FullScreen">
                  <i class="fa fa-expand"></i>
                </button>
              </div>
            </div>

            <div class="top-info-holder">

              <div class="title-views-section">
                <h2 class="video-title"><span *ngIf="video['stat'] === 0">[PRIVATE] </span><span id="vtitle">{{ video['title'] }}</span></h2>
                <div class="d-flex">
                  <div class="mr-auto" id="visits">{{ visits }} views</div>

                  <a *ngIf="isAdmin || isOwner" class="ml-auto" (click)="openEditVideoDialog(video)"><mat-icon color="accent">settings</mat-icon></a>
                </div>
<!--                <div #editPanel class="m-0" style="display: none;" *ngIf="isAdmin || isOwner">-->
<!--                  <input #valueInput class="form-control float-right m-1" type="text" id="editValue" placeholder="Value to set when editing" />-->
<!--                  <button class="btn btn-warning float-right m-1" (click)="deleteCurrentVideo()">Delete video</button>-->
<!--                  <button class="btn btn-outline-secondary float-right m-1" (click)="editStat()">Edit stat</button>-->
<!--                  <button class="btn btn-outline-primary float-right m-1" (click)="editTags(valueInput.value)">Edit tags</button>-->
<!--                  <button class="btn btn-secondary float-right m-1" (click)="editDesc(valueInput.value)">Edit desc</button>-->
<!--                  <button class="btn btn-primary float-right m-1 rounded-right" (click)="editTitle(valueInput.value)">Edit title</button>-->
<!--                </div>-->

              </div>

            </div>

            <div class="info">
              <div class="add-by">
                <div class="avatar"><a href="#"><img class="rounded-circle" src="{{ authorAvatar }}"  alt="Author's avatar"/></a></div>
                <div class="uploaded">
                  <a href="#" id="author">{{ author }}</a>
                  <p id="date">Added on {{ uploadDate }}</p>
                  <div #descriptionDiv class="desc">
                    <span class="description" style="white-space: pre-wrap;">{{ video['desc'] }}</span>
                    <br><br><hr class="mt-4 mb-0 pb-2 border-light"><p class="pb-0 mb-0 text-white-50" style="font-size: 11px;">Tags:</p>
                    <a *ngFor="let tag of video['tags']" class="btn btn-sm btn-outline-info ml-0 mr-1 my-1 px-1" [routerLink]="['/finder']" [queryParams]="{ q: tag, page: 1 }">{{ tag }}</a>
                  </div>
                  <a #showDescLink href="javascript:void(0)" id="sh_desc">Show more</a>
                </div>
              </div>
            </div>


            <app-comments></app-comments>
            <div class="comment-section" [ngStyle]="{ 'display': timeoutEnded ? '' : 'none;' }">
              <h3>Comments</h3>

              <div class="media mt-3 shadow-textarea mb-4">
                <img id="avatar" class="d-flex rounded-circle avatar z-depth-1-half mr-3 mt-1" alt="Current user avatar" src="{{ userAvatar }}">
                <div class="media-body">
                  <form [formGroup]="commentForm" (ngSubmit)="addComment()" class="form-group rounded-corners" enctype="multipart/form-data">

                    <mat-form-field class="w-100" color="accent" appearance="outline">
                      <mat-label>Write new comment here (min. 5 signs)</mat-label>
                      <textarea matInput #commentInput name="text" formControlName="text" type="text" minlength="5" maxlength="500" class="comment-input"></textarea>
                      <mat-hint align="end">{{commentInput.value.length}} / 500</mat-hint>
                    </mat-form-field>

                    <div class="comment-form-actions">
                      <button mat-raised-button color="accent" class="mt-1" [disabled]="commentForm.invalid">Add</button>
                    </div>
                  </form>
                </div>
              </div>

              <div class="comments" *ngIf="comments.length > 0">
                <div *ngFor="let comment of comments" class="media">
                  <img class="d-flex rounded-circle avatar z-depth-1-half mr-3" src="{{ comment.authorAvatar }}"
                       alt="{{ comment.author }}s' avatar">
                  <div class="media-body">
                    <h5 class="mt-0 mb-1 font-weight-bold blue-text comment-author">{{ comment.author }}</h5>
                    <p class="comment-message" style="white-space: pre;">{{ comment.text }}</p>
                  </div>

                  <button *ngIf="comment.author === currentUser || isAdmin" class="video-actions-menu" mat-icon-button [matMenuTriggerFor]="menu" aria-label="Video actions" #menuTrigger>
                    <mat-icon>more_vert</mat-icon>
                  </button>
                  <mat-menu #menu="matMenu">
                    <button mat-menu-item (click)="openEditCommentDialog(comment)">
                      <mat-icon>edit</mat-icon>
                      <span>Edit</span>
                    </button>
                    <button mat-menu-item (click)="deleteComment(comment.id)">
                      <mat-icon>delete_forever</mat-icon>
                      <span>Delete</span>
                    </button>
                  </mat-menu>
                </div>
              </div>

              <h4 *ngIf="comments.length === 0">No comments</h4>

            </div>


          </div>
<!--            </div>-->

          <div class="next-video-section" *ngIf="similarVideos.length > 0">

            <div class="options-section">
              <mat-slide-toggle
                class="example-margin"
                [checked]="autoPlayNext"
                (change)="onAutoPlayToggle($event)"
                [color]="color"
                >
                Autoplay next video
              </mat-slide-toggle>

              <button
                class="mt-2 w-100"
                mat-raised-button
                color="primary"
                matTooltip="Save to playlist"
                matTooltipPosition="before"
                (click)="openPlaylistActionsDialog()"
              ><mat-icon>star</mat-icon></button>

            </div>

            <div class="selected-video-section">
              <div id="autoplayVideo" class="suggestedVideo h-100" (click)="play(similarVideos[0].id)" matTooltip="Play: {{ similarVideos[0].title }}" matTooltipPosition="before">
                <img src="{{ baseUrl }}/{{ similarVideos[0].cover }}" class="img-fluid" alt="{{ similarVideos[0].title }}">
                <div class="similar-movie-info">
                  <strong style="word-break: break-word;">{{ (similarVideos[0].title.length > 30 ? similarVideos[0].title.slice(0, 30) + '...' : similarVideos[0].title) }}</strong>
                  <span style="font-size: 11px; color: rgba(50,170,255,0.8)" title="{{ similarVideos[0].author }}">{{ similarVideos[0].author }}</span>
                </div>
              </div>
            </div>

            <app-playlist
              class="playlist-section"
              *ngIf="playlistLoaded | async"
              [playlist]="playlist"
              [video]="video"
              (playlistChange)="playlist = $event"
            ></app-playlist>
<!--            <div class="playlist-section" *ngIf="playlist !== null">-->
<!--              <mat-expansion-panel hideToggle>-->
<!--                <mat-expansion-panel-header>-->
<!--                  <mat-panel-title>-->
<!--                    <mat-icon style="vertical-align: middle;" >playlist_play</mat-icon> {{ playlist.name }}-->
<!--                  </mat-panel-title>-->
<!--                  <mat-panel-description *ngIf="playlist['isPrivate']" >-->
<!--                    <mat-icon style="vertical-align: middle;" class="ml-auto" title="Private">https</mat-icon>-->
<!--                  </mat-panel-description>-->
<!--                </mat-expansion-panel-header>-->

<!--                <mat-grid-list cols="5" rowHeight="120px">-->
<!--                  <a class="playlist-item" *ngFor="let video of playlist['videos']" [href]="'/player?vid=' + video['_id'] + '&list=' + playlist['_id']">-->
<!--                    <mat-grid-tile-->
<!--                      [colspan]="2"-->
<!--                      [rowspan]="1"-->
<!--                    >-->
<!--                      <img class="img-fluid mr-4" [src]="baseUrl + '/' + video['cover']" [alt]="video['title'] + ' cover image'">-->
<!--                    </mat-grid-tile>-->
<!--                    <mat-grid-tile-->
<!--                      [colspan]="3"-->
<!--                      [rowspan]="1"-->
<!--                    >-->
<!--                      {{ video['title'] }}-->
<!--                    </mat-grid-tile>-->
<!--                  </a>-->
<!--                </mat-grid-list>-->

<!--              </mat-expansion-panel>-->

<!--            </div>-->

          </div>

          <hr class="my-2" *ngIf="similarVideos.length > 1">

          <div class="similar-videos-section" *ngIf="similarVideos.length > 1">

            <div class="font-weight-light">
              <div class="similar-container">

                <div *ngFor="let similarVideo of similarVideos.slice(1, similarOnPage)" title="Play: {{ similarVideo.title }}">

                  <div class="suggestedVideo h-100" (click)="play(similarVideo.id)">

                      <img src="{{ baseUrl }}/{{ similarVideo.cover }}" class="img-fluid" alt="{{ similarVideo.title }}">
                      <div class="similar-movie-info">
                        <strong style="font-size: 12px; word-break: break-word;">{{ (similarVideo.title.length > 30 ? similarVideo.title.slice(0, 30) + '...' : similarVideo.title) }}</strong>
                        <span style="font-size: 11px; color: rgba(50,170,255,0.8)" title="{{ similarVideo.author }}">{{ similarVideo.author }}</span>
                      </div>

                  </div>

                </div>

              </div>
            </div>

          </div>


        </div>

    </div>

    <div class="container" *ngIf="error !== null">
      <div class="alert alert-danger">{{ error }}</div>
    </div>
</div>

<div class="container mt-4" *ngIf="error !== null && !(videoLoaded | async)">
  <div class="alert alert-danger">{{ error }}</div>
</div>
